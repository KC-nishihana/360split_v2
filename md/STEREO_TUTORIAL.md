# 360Split ステレオ機能チュートリアル

**対象:** 初めて 360Split でステレオビデオを扱うユーザー
**所要時間:** 約15分
**難易度:** 初級

---

## 🎯 このチュートリアルで学ぶこと

- OSV ファイルの準備と確認方法
- GUI でのステレオビデオ読み込み
- 5種類のステレオ表示モードの使い方
- キーフレーム解析とエクスポート
- CLI での一括処理

---

## 📋 準備

### 必要なもの

1. **360Split v2** がインストールされていること
2. **ffmpeg** がインストールされていること
3. **OSV ファイル** または左右の動画ファイル

### ffmpeg のインストール確認

```bash
# ターミナルで実行
which ffmpeg

# バージョン確認
ffmpeg -version
```

**未インストールの場合：**

```bash
# macOS
brew install ffmpeg

# Ubuntu/Debian
sudo apt install ffmpeg
```

---

## Part 1: OSV ファイルの準備

### ステップ 1.1: 左右の動画を用意

このチュートリアルでは、以下のファイルがあると仮定します：

- `left.mp4` - 左目ストリーム
- `right.mp4` - 右目ストリーム

**動画の要件：**
- 同じ解像度（例: 3840x1920）
- 同じフレームレート（例: 30fps）
- 同じフレーム数
- 同期が取れていること

### ステップ 1.2: OSV ファイルを作成

```bash
# 左右の動画を OSV コンテナに結合
ffmpeg -i left.mp4 -i right.mp4 \
  -map 0:v -map 1:v \
  -c copy \
  test_stereo.osv
```

**コマンドの説明：**
- `-i left.mp4 -i right.mp4`: 入力ファイル2つ
- `-map 0:v`: 1つ目の入力のビデオストリームを使用
- `-map 1:v`: 2つ目の入力のビデオストリームを使用
- `-c copy`: 再エンコードせずにコピー（高速）
- `test_stereo.osv`: 出力ファイル名

### ステップ 1.3: OSV ファイルを確認

```bash
# ストリーム情報を確認
ffprobe test_stereo.osv
```

**期待される出力：**
```
Input #0, mov,mp4,m4a,3gp,3g2,mj2, from 'test_stereo.osv':
  ...
  Duration: 00:01:30.00, start: 0.000000, bitrate: 50000 kb/s
    Stream #0:0: Video: h264, yuv420p, 3840x1920, 30 fps
    Stream #0:1: Video: h264, yuv420p, 3840x1920, 30 fps
```

✅ **ポイント:** ストリームが2つ（#0:0 と #0:1）あることを確認

---

## Part 2: GUI でステレオビデオを開く

### ステップ 2.1: 360Split を起動

```bash
# ターミナルで実行
cd /path/to/360split
python main.py
```

**起動画面：**
```
┌────────────────────────────────────────────────┐
│ 360Split v2 — キーフレーム抽出ツール            │
├────────────────────────────────────────────────┤
│                                                │
│          ビデオを開いてください                   │
│                                                │
│  （ドラッグ＆ドロップまたはメニューから選択）        │
│                                                │
└────────────────────────────────────────────────┘
 [準備完了 — 動画ファイルをドラッグ＆ドロップで読み込めます]
```

### ステップ 2.2: OSV ファイルを開く

**方法A: メニューから**

1. メニューバー → **ファイル(F)** → **開く(&O)...** をクリック
2. ファイル選択ダイアログが開く
3. `test_stereo.osv` を選択
4. **開く** ボタンをクリック

**方法B: ドラッグ＆ドロップ**

1. ファイルマネージャーで `test_stereo.osv` を探す
2. 360Split のウィンドウにドラッグ
3. ウィンドウ上でドロップ

### ステップ 2.3: 読み込み確認

**ステータスバーの表示：**
```
読み込み完了（OSV - ステレオ）: test_stereo.osv  (3840×1920, 30.0fps, 2700フレーム) - ステレオ表示可能
```

**ビデオプレーヤーの状態：**
```
┌────────────────────────────────────────────────┐
│                                                │
│      [左目ストリームが表示される]                  │
│                                                │
└────────────────────────────────────────────────┘
 [▶ 再生] [◀] [▶] [⏮] [⏭] [Grid OFF] [ステレオ: Side-by-Side▼] [★ マーク]
                                        ↑
                               新しく表示される！
```

✅ **ポイント:** 「ステレオ:」コンボボックスが表示されたら成功

---

## Part 3: ステレオ表示モードを試す

### ステップ 3.1: Side-by-Side 表示

1. **ステレオ:** コンボボックスで **Side-by-Side** を選択（デフォルト）

**画面イメージ：**
```
┌──────────────────┬──────────────────┐
│      LEFT        │      RIGHT       │
│                  │                  │
│  [左目映像]       │  [右目映像]       │
│                  │                  │
│                  │                  │
└──────────────────┴──────────────────┘
       ↑                  ↑
    緑の境界線
```

**確認ポイント：**
- 左右の映像が並んで表示される
- 中央に緑の縦線が表示される
- 左上に "LEFT"、右上に "RIGHT" のラベル
- 視差（視点のズレ）が確認できる

### ステップ 3.2: アナグリフ表示

1. **ステレオ:** コンボボックスで **アナグリフ** を選択
2. 赤青メガネを装着（左目：赤、右目：青）

**画面イメージ：**
```
┌────────────────────────────────────┐
│                                    │
│  [赤青が重なった映像]                │
│  （立体的に見える）                   │
│                                    │
└────────────────────────────────────┘
```

**確認ポイント：**
- 赤青が重なった映像が表示される
- 赤青メガネで見ると立体的に見える
- グレースケール処理されている

**注意:** 赤青メガネがない場合は、次の表示モードに進んでください。

### ステップ 3.3: 左のみ表示

1. **ステレオ:** コンボボックスで **左のみ** を選択

**画面イメージ：**
```
┌────────────────────────────────────┐
│                                    │
│      [左目映像のみ表示]              │
│                                    │
└────────────────────────────────────┘
```

**用途：**
- 左目フレームの詳細確認
- 通常の2D表示として使用

### ステップ 3.4: 右のみ表示

1. **ステレオ:** コンボボックスで **右のみ** を選択

**画面イメージ：**
```
┌────────────────────────────────────┐
│                                    │
│      [右目映像のみ表示]              │
│                                    │
└────────────────────────────────────┘
```

**用途：**
- 右目フレームの詳細確認
- 左右比較時の切り替え

### ステップ 3.5: L/R 切り替え表示

1. **ステレオ:** コンボボックスで **L/R切替** を選択
2. 自動的に左右が切り替わる様子を観察

**動作：**
- 500ms ごとに左右が自動切り替え
- フリッカー効果で視差を確認

---

## Part 4: ビデオ再生とプレビュー

### ステップ 4.1: 基本的な再生操作

1. **▶ 再生** ボタンをクリック → 再生開始
2. もう一度クリック → 停止

**キーボードショートカット：**
- **Space**: 再生/停止切り替え
- **←**: 前のフレーム
- **→**: 次のフレーム
- **Home**: 先頭フレーム
- **End**: 最終フレーム

### ステップ 4.2: 再生速度の変更

1. **速度:** コンボボックスをクリック
2. 任意の速度を選択（0.25x ～ 4.0x）

**推奨設定：**
- **0.5x**: 詳細確認時
- **1.0x**: 通常再生
- **2.0x**: 高速プレビュー

### ステップ 4.3: フレーム単位のシーク

1. スライダーをドラッグ → 即座にフレーム移動
2. フレーム番号入力ボックスに数値を入力 → Enter

**例：**
```
フレーム: [0001500] / 2700
```
→ フレーム1500 に移動

### ステップ 4.4: グリッドオーバーレイ（360度動画の場合）

360度 Equirectangular 動画の場合：

1. **Grid OFF** ボタンをクリック
2. グリッド線が表示される
3. もう一度クリック → グリッド非表示

---

## Part 5: キーフレーム解析

### ステップ 5.1: フル解析を開始

1. メニューバー → **解析(A)** → **フル解析 (Stage 1+2)(&R)**
   - または **Ctrl+R** キーボードショートカット

2. 解析が開始される

**進捗表示：**
```
 [████████████████░░░░] 80%  Stage 2: 2160/2700
```

**所要時間（目安）：**
- 4K 30fps 1分動画: 約3～5分
- 8K 30fps 1分動画: 約10～15分

### ステップ 5.2: 解析結果の確認

解析完了後：

**タイムライン：**
```
スコアグラフ:
  1.0 ┤     ╭─╮     ╭──╮
  0.8 ┤  ╭──╯ ╰──╮  │  │
  0.6 ┤ ╭╯       ╰─╯  ╰╮
  0.4 ┤─╯             ╰─
      └────────────────────→ Frame
       |  |  |  |  |  |
       ↑  ↑  ↑  ↑  ↑  ↑
    キーフレーム位置（緑の縦線）
```

**キーフレーム一覧：**
```
キーフレーム (42個)
  Frame 0001  | Score 0.8521
  Frame 0050  | Score 0.9102
  Frame 0100  | Score 0.8834
  ...
```

**ステレオ解析の特徴：**
- 左右両方のフレームが品質評価される
- 両方が基準を満たすフレームのみ選択される

### ステップ 5.3: キーフレームのプレビュー

1. キーフレーム一覧でフレームをクリック
2. ビデオプレーヤーがそのフレームにジャンプ
3. ステレオ表示モードで確認

**キーフレームインジケータ：**
```
┌────────────────────────────────────┐
│                        [✅ Keyframe]│
│      [映像表示]                      │
│                                    │
└────────────────────────────────────┘
```

---

## Part 6: キーフレームのエクスポート

### ステップ 6.1: エクスポートダイアログを開く

1. メニューバー → **ファイル(F)** → **キーフレームをエクスポート(&E)...**
   - または **Ctrl+Shift+E**

### ステップ 6.2: 出力設定

**エクスポートダイアログ：**
```
┌─ キーフレームエクスポート ────────────────┐
│                                        │
│  出力ディレクトリ:                        │
│  [/path/to/output/          ] [参照]   │
│                                        │
│  画像フォーマット:                        │
│  ○ PNG  ○ JPG  ○ TIFF                 │
│                                        │
│  JPEG 品質: [95] (JPGの場合)            │
│                                        │
│  ファイル名プレフィックス: [keyframe]     │
│                                        │
│  ☐ 360度処理                           │
│  ☐ マスク処理                           │
│  ☐ Cubemap 出力                        │
│                                        │
│              [キャンセル] [エクスポート]  │
└────────────────────────────────────────┘
```

**推奨設定：**
- **フォーマット**: PNG（可逆圧縮）または JPG 95%以上
- **360度処理**: 必要に応じて有効化
- **マスク処理**: 撮影者/三脚を除去したい場合

### ステップ 6.3: エクスポート実行

1. **エクスポート** ボタンをクリック
2. 進捗バーが表示される

**進捗表示：**
```
 [████████████████████] 100%  エクスポート: 42/42
```

**ステータスバー：**
```
エクスポート: ステレオペア出力モード（L/R）
```

### ステップ 6.4: 出力結果の確認

```bash
# ターミナルで確認
ls -l /path/to/output/
```

**出力ファイル：**
```
keyframe_000001_L.png
keyframe_000001_R.png
keyframe_000050_L.png
keyframe_000050_R.png
keyframe_000100_L.png
keyframe_000100_R.png
...
keyframe_metadata.json
```

**ファイル命名規則：**
- `{prefix}_{frame_index:06d}_L.{ext}` - 左目
- `{prefix}_{frame_index:06d}_R.{ext}` - 右目

✅ **成功！** ステレオペアが出力されました

---

## Part 7: CLI での一括処理

### ステップ 7.1: 基本的なCLI実行

```bash
# OSV ファイルを解析してエクスポート
python main.py --cli test_stereo.osv --output cli_output/
```

**出力例：**
```
============================================================
360Split - CLIモード
============================================================
入力動画: test_stereo.osv
出力先:   cli_output/
フォーマット: png
ステレオモード（OSV）: 有効（L/Rペア出力）
------------------------------------------------------------
ステレオストリームを分離しました: L=temp_streams/test_stereo_left.mp4, R=temp_streams/test_stereo_right.mp4
動画情報: 3840x1920, 30.0fps, 2700フレーム, 90.0秒
キーフレーム解析を開始...
進捗: 10%
進捗: 20%
...
進捗: 100%
検出キーフレーム数: 42
キーフレームを出力中...
  [1/42] Frame 000001 (L/R) | Time    0.03s | Score 0.8521
  [2/42] Frame 000050 (L/R) | Time    1.67s | Score 0.9102
  ...
------------------------------------------------------------
完了: 42 キーフレームを出力しました
出力先: cli_output/
メタデータ: cli_output/keyframe_metadata.json
```

### ステップ 7.2: プリセットを使った処理

```bash
# 屋外プリセット（高品質重視）
python main.py --cli test_stereo.osv --preset outdoor --output outdoor_output/

# 屋内プリセット（暗所対応）
python main.py --cli test_stereo.osv --preset indoor --output indoor_output/
```

### ステップ 7.3: 360度処理との組み合わせ

```bash
# Equirectangular 変換 + マスク
python main.py --cli test_stereo.osv \
  --equirectangular \
  --apply-mask \
  --output eq_output/

# Cubemap 出力
python main.py --cli test_stereo.osv \
  --equirectangular \
  --cubemap \
  --output cubemap_output/
```

**Cubemap 出力結果：**
```
cubemap_output/
├── keyframe_000001_L.png
├── keyframe_000001_R.png
├── cubemap/
│   ├── frame_000001_L/
│   │   ├── front.png
│   │   ├── back.png
│   │   ├── left.png
│   │   ├── right.png
│   │   ├── top.png
│   │   └── bottom.png
│   └── frame_000001_R/
│       ├── front.png
│       └── ...
```

---

## Part 8: COLMAP との連携

### ステップ 8.1: キーフレーム抽出

```bash
# COLMAP 用にキーフレーム抽出
python main.py --cli test_stereo.osv \
  --preset outdoor \
  --output colmap_images/
```

### ステップ 8.2: COLMAP で SfM

```bash
# 特徴点抽出
colmap feature_extractor \
  --database_path database.db \
  --image_path colmap_images/

# マッチング
colmap exhaustive_matcher \
  --database_path database.db

# SfM
colmap mapper \
  --database_path database.db \
  --image_path colmap_images/ \
  --output_path sparse/
```

### ステップ 8.3: 結果確認

```bash
# COLMAP GUI で結果を表示
colmap gui \
  --database_path database.db \
  --image_path colmap_images/
```

---

## 🎓 まとめ

### 学んだこと

✅ OSV ファイルの作成と確認
✅ GUI でのステレオビデオ読み込み
✅ 5種類のステレオ表示モードの使い方
✅ キーフレーム解析の実行
✅ ステレオペアのエクスポート
✅ CLI での一括処理
✅ COLMAP との連携

### 次のステップ

1. **独自のOSVファイルで試す**
   - 実際のステレオ360度カメラで撮影
   - 自分のプロジェクトで使用

2. **高度な設定を試す**
   - カスタム設定ファイルの作成
   - バッチ処理スクリプトの作成

3. **3D再構成に挑戦**
   - COLMAP で点群生成
   - 3D Gaussian Splatting で学習

---

## 💡 ヒントとコツ

### パフォーマンス最適化

- **初回読み込みは時間がかかる**
  - OSV ストリーム分離に時間がかかる
  - 2回目以降はキャッシュが使われて高速

- **解像度を下げる**
  - 4K → 2K にダウンスケールで処理高速化
  - テスト時は低解像度で確認

### 品質向上

- **プリセットを活用**
  - 撮影環境に合ったプリセットを選択
  - カスタマイズも可能

- **手動マーク機能**
  - 重要なフレームを手動でマーク（★ マークボタン）
  - 自動検出を補完

### トラブル対処

- **左右が同期していない**
  - 元の動画を確認
  - フレーム数を揃える

- **メモリ不足**
  - サンプリング間隔を広げる（`--min-interval`）
  - 低解像度で処理

---

## 📚 参考資料

- **ユーザーマニュアル**: `STEREO_USER_MANUAL.md`
- **テストガイド**: `OSV_TESTING_GUIDE.md`
- **実装状況**: `OSV_IMPLEMENTATION_STATUS.md`
- **変更履歴**: `CHANGELOG_OSV.md`

---

**作成日**: 2026-02-12
**バージョン**: 1.0.0
**対象バージョン**: 360Split v2.0

お疲れ様でした！🎉
