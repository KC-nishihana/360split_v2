### 360度動画ベース3D再構成GUIソフトウェア：キーフレーム選択機能・技術仕様書

#### 1\. システム概要と開発目的

本システムは、360度動画を中間的な表現形式（プロキシ）として活用し、歩行可能な高品質3D空間を再構成するための、CVエンジニアおよび非専門家（考古学者・測量士等）向けの統合ソフトウェアである。「遺構調査（Qubbet el-Hawa等）」における狭小空間のドキュメンテーションにおいて、全天球情報の冗長性を排除し、幾何学的整合性を担保したモデルを生成することが本システムの戦略的価値である。設計理念として、本ソフトウェアは「WorldPrompter」の概念を拡張し、 **フィードフォワード型Reconstructor（Long-LRM）による迅速な現地プレビュー** と、 **最適化ベースの再構成（SparseGS/RegGS）による高精度出力** というハイブリッド・ワークフローを採用する。膨大な動画フレームを無差別に処理するのではなく、幾何学的な「情報の質」に基づくキーフレーム選別を行うことで、計算リソースを最適化し、SfM過程におけるドリフトや「背景の崩落」といったエラーの蓄積を物理的に防止する。

#### 2\. キーフレーム選択アルゴリズムの多角的メカニズム

キーフレームの抽出は、単なる時間的な間引きではなく、後続のGaussian Splatting最適化を安定させるための「幾何学的制約の最適化」プロセスである。

##### 2.1 画質・深度評価（Quality-based Selection）

従来のラプラシアンスコア（鮮明度）に加え、再構成の確実性を担保する独自の深度指標を導入する。

* **Softmax-scaling Depth（ソフトマックス・スケーリング深度）:**  式  $d^{softmax} \= \\log(\\frac{\\sum w\_i e^{\\beta w\_i} d\_i}{\\sum w\_i e^{\\beta w\_i}})$  に基づき、温度パラメータ  $\\beta$  を用いて寄与度の高いガウス分布を強調。これにより、フローター（浮遊ノイズ）の不確実性を定量化し、高品質なフレームを優先する。  
* **モーションブラーおよび輝度・露光評価:**  エッジ強度解析に加え、不鮮明なエッジが深度勾配に与える悪影響を排除。

##### 2.2 幾何学的配置およびポーズアライメント（Geometric Selection）

SfMの成功に不可欠な視差と、未定義ポーズ（Unposed）フレームの整合性を評価する。

* **GRICスコアによる視差評価:**  ホモグラフィと基礎行列の適合度を比較し、再構成に寄与する十分な視差を確保。  
* **Entropy-regularized Sinkhornアルゴリズムによるアライメント:**  ポーズ未定の疎な視点群に対し、MW2（2-Wasserstein）距離を距離尺度としてSim(3)空間でのアライメントを高速に計算。  
* **特徴点の分散バランス:**  Plücker座標系へ投影した際のレイ（Ray）の分散を評価し、特定の空間領域への偏りを抑制。

##### 2.3 コンテンツ適応型選別（Adaptive Selection）

シーンの変化に応じた動的なサンプリング周波数の制御。

* **SSIM（構造的類似性）による変化検知:**  構造的差異が閾値を超えた場合にキーフレームを生成。  
* **カメラ・モーメンタム認識:**  加速度の変化が大きい旋回時、情報の欠落を防ぐためにサンプリング密度を一時的に向上させる。

#### 3\. 360度画像処理：魚眼(FEI) vs 球面(SI) モジュール設計

360度カメラ特有の歪曲と投影特性を幾何学的に正しく扱うため、2つの処理パスを実装する。

##### 3.1 魚眼画像（FEI）直接利用：高精度パス

キャリブレーション済みの多眼魚眼レンズから得られる生のデータを直接処理する。

* **Plücker Ray変換:**  正距円筒図法の幾何的整合性を維持するため、キャリブレーションされたポーズをPlücker座標へと変換。これをLong-LRM等のReconstructorの入力とする。  
* **スケールバー（SBs）とGCP削減:**  レンズ間の固定距離（ROP）を事前拘束条件として用いることで、地上基準点（GCP）を最小限（最低3点）に抑えた状態で正確なメートル単位のスケールを実現。

##### 3.2 球面画像（SI）生成：高速パス

複数のレンズ画像を繋ぎ合わせ、Equirectangular形式で出力する。| 手法 | 名称 | 技術的特徴 | 推奨用途 || \------ | \------ | \------ | \------ || **SI-FS** | Fast Stitching | 高速なピクセルベース接合。 | フィールドでの低解像度プレビュー。 || **SI-HQS** | High Quality Stitching | SIFT等による特徴点マッチング接合。 | 一般的な遺構記録。 || **SI-DMS** | Depth Map Stitching | **深度マップ** を考慮しパララックスを最小化。 | **複雑な幾何形状を含む狭小空間。** |

#### 4\. 高度な3D再構成とアーティファクト除去パイプライン

##### 4.1 3D Gaussian Splatting (3DGS) とモデル・ステッチング

VIST3Aのコンセプトに基づき、3D再構成ネットワークをビデオVAE潜在空間（Latent Space）に直接ステッチする。

* **Latent Space Stitching:**  3D基盤モデルをVAEの潜在空間に統合し、軽量な線形マッピングを用いて接続。これにより、生成過程における潜在的なノイズに対して堅牢なデコードを可能にする。

##### 4.2 マスク処理とノイズ排除（Masked Diffusion Loss）

360度撮影において不可欠な、撮影者の存在を「幾何学的に」消去する技術。

* **Binary Mask (M) の自動生成:**  セマンティック・セグメンテーションにより、撮影者や機材のフットプリントを特定。  
* **Masked Diffusion Loss:**   $E\_{x\\sim p\_{data}, t} \\| M \\odot (\\epsilon\_t \- f\_\\theta) \\|^2$  の計算式に基づき、マスク領域（ $M=0$ ）を損失計算から除外。これにより、撮影者が3D空間に「焼き付く」現象を排除する。

##### 4.3 疎な視点からの最適化とPruning（SparseGS）

少ないキーフレームから発生する「フローター」を排除するための、幾何学的なプルーニング手法。

* **高度な剪定（Pruning）:**   $\\Delta\_i \= (d^{mode} \- d^{alpha}) / d^{alpha}$ （Mode-selection深度とAlpha-blending深度の相対差）を評価関数とし、不一致が大きいガウス分布を自動的に削除。  
* **深度プライア（Depth Priors）:**  Monocular深度推定とSDS（Score Distillation Sampling）損失を組み合わせ、未観測の視点における背景の崩落を抑制。

#### 5\. データ仕様およびパフォーマンス要件

##### 5.1 入出力データ形式

* **入力:**  4K/8K 360度動画（mp4, 24/12 fps）、内部・外部オリエンテーション・パラメータ。  
* **出力:**  3D Gaussian Splat (.ply)、最適化点群、Latent Decoded Preview。

##### 5.2 ハードウェアおよびパフォーマンス要件

プロフェッショナルな現場運用を想定したベンチマークを定義する。

* **VRAM制約:**  8K Equirectangular処理には、最低  **12GB VRAM** （NVIDIA RTX 3080以上）を推奨。  
* **処理スピード:**  
* **Quick Preview:**  フィードフォワード型Reconstructorにより、10秒の動画から数秒〜数分で再構成。  
* **Iterative Refinement:**  SparseGSプルーニングおよび最適化工程を含め、1時間以内での高品質モデル生成。

##### 5.3 運用ワークフロー

本システムは、現地での「Latent Previewing（被覆範囲の確認）」と、ラボでの「High-Precision Optimization」をシームレスに結合する。これにより、データの欠損を現場で即座に発見し、帰社後の高度な解析・VRナビゲーションを担保する。**結語**  本ソフトウェアは、キーフレーム選択という上流工程に高度な幾何学的評価（Sinkhorn、Softmax深度、Plücker座標）を導入することで、次世代の3DGS再構成における「処理の堅牢性」と「計測精度」を極限まで高めている。直感的なGUIを通じて、専門職は複雑なCVアルゴリズムを意識することなく、遺構のデジタルツインを迅速かつ高精度に構築することが可能となる。  
