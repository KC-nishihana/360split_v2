# OSVファイル メタデータ調査レポート

## 実行日
2026年2月13日

## 調査対象
`CAM_20260205143223_0028_D.OSV` (1.57 GB)

---

## 📋 調査結果サマリー

### ✅ 発見されたデータ

| データ種類 | 状態 | 詳細 |
|-----------|------|------|
| **加速度データ** | ✅ **取得済み** | AccelerometerX/Y/Z (2,310サンプル, 30Hz) |
| **ジャイロデータ** | ❌ **未検出** | AngularVelocity データなし |
| **GPSデータ** | ❌ **未検出** | 位置情報なし |
| **磁気センサー** | ❌ **未検出** | Magnetometer データなし |
| **気圧センサー** | ❌ **未検出** | Pressure/Altitude データなし |
| **カメラメタデータ** | ✅ **検出** | Protobuf形式 (複数ストリーム) |
| **デバッグ情報** | ✅ **検出** | 20MB x 2ストリーム |

---

## 🔍 詳細分析

### 1. ファイル構造

OSVファイルはMP4コンテナで、以下のストリームを含んでいます：

```
Stream 0: 左目映像 (HEVC, 3840x3840, 30fps) - 77秒
Stream 1: 右目映像 (HEVC, 3840x3840, 30fps) - 77秒
Stream 2: 音声 (AAC, 48kHz, stereo)
Stream 3: カメラメタデータ (djmd, 2.1 MB) ⭐
Stream 4: カメラメタデータ (djmd, 325 KB) ⭐
Stream 5: デバッグ情報 (dbgi, 20 MB)
Stream 6: デバッグ情報 (dbgi, 20 MB)
```

### 2. メタデータボックス

MP4コンテナ内の特殊なボックス：

#### camd Box (Camera Metadata)
- **サイズ**: 2.53 MB (2,529,934 バイト)
- **位置**: 0x6432FD29
- **内容**: Protobuf形式のカメラメタデータ
- **サンプル数**: 2,310 (30Hz, 77秒)
- **サンプルサイズ**: 約1,095バイト/サンプル

#### udta Box (User Data)
- **サイズ**: 83,339 バイト
- **内容**: デバイス情報、設定など

#### meta Box (Metadata)
- 2つのメタデータボックスを検出
- デバイス情報とハンドラー情報を含む

### 3. Protobufデータ

#### Stream 3 & 4 (djmd - DJI Metadata)

**検出された情報**:
```
スキーマ: dvtm_oq101.proto
バージョン: 02.01.14
ファームウェア: 2.0.8
シリアル番号: 95SXN8N042190P2
ファームウェア日付: 10.00.21.20
デバイス名: Osmo 360
モデル: Osmo OQ001
```

**データ形式**:
- Protobuf (Protocol Buffers) バイナリ形式
- 各フレームに対応するメタデータパケット
- 浮動小数点数（32bit float）を多数含む

**含まれる可能性のあるデータ**:
- カメラの内部パラメータ
- 露出設定
- ホワイトバランス
- 手ぶれ補正パラメータ
- フレーム間の同期情報

#### Stream 5 & 6 (dbgi - Debug Information)

**検出された情報**:
```
スキーマ: dbginfo_oq101.proto
バージョン: 2.0.2
イメージセンサー: OV68A40 (OmniVision製)
```

**データサイズ**: 各20 MB (非常に大きい)

**推定内容**:
- デバッグログ
- 内部処理パラメータ
- 画像処理パイプラインの詳細
- エラーログ

---

## 🎯 自己位置推定への影響

### 利用可能なデータ

#### ✅ 1. 加速度データ (既に抽出済み)
```
データ: AccelerometerX, AccelerometerY, AccelerometerZ
サンプル数: 2,310
サンプリングレート: 30 Hz
期間: 77秒
単位: g (重力加速度)
```

**用途**:
- 二重積分による位置推定（精度は限定的）
- 移動パターンの検出
- 振動解析

**制限事項**:
- 重力成分の除去が必要
- ドリフト誤差の蓄積
- 姿勢情報なしでは座標変換が不正確

### ❌ 2. ジャイロスコープデータ

**状態**: **検出されず**

**調査方法**:
- Protobufタグ検索 (`AngularVelocity`, `Gyro`, `gyro`)
- exiftool出力の確認
- 手動バイナリ解析

**結論**: このOSVファイルにはジャイロデータが含まれていない

**影響**:
- カメラの姿勢変化を追跡できない
- 加速度の座標系変換が不可能
- IMUベースの高精度位置推定は困難

### ❌ 3. GPSデータ

**状態**: **検出されず**

**調査方法**:
- MP4メタデータボックス検索 (`gps`, `GPS`, `©xyz`)
- Protobufデータ検索 (`Latitude`, `Longitude`, `GPS`)
- 全ストリームの文字列検索

**結論**: GPSデータは含まれていない

**理由の推測**:
- 屋内撮影用カメラ
- GPS受信機が非搭載
- プライバシー設定でGPS記録が無効化

### ❌ 4. その他のセンサー

以下のセンサーデータも検出されませんでした：

- **磁気センサー** (Magnetometer, Compass)
- **気圧センサー** (Barometer, Pressure, Altitude)
- **温度センサー**

---

## 💡 追加調査の可能性

### Protobufスキーマの取得

**問題**: Protobufデータを完全に解析するには、`.proto`スキーマファイルが必要

**検出されたスキーマ名**:
1. `dvtm_oq101.proto` (カメラメタデータ)
2. `dbginfo_oq101.proto` (デバッグ情報)

**取得方法**:
1. **DJI公式SDK**: DJI Osmo 360の開発者向けSDKに含まれている可能性
2. **リバースエンジニアリング**: Protobufバイナリから型情報を推測
3. **exiftool**: より詳細な抽出機能（要インストール）

### exiftoolによる詳細抽出

**推奨コマンド**:
```bash
# exiftoolのインストール（root権限が必要）
sudo apt-get install exiftool

# 全Protobufデータの抽出
exiftool -ee3 -api Unknown=2 -G -a -s CAM_20260205143223_0028_D.OSV > full_metadata.txt

# 特定のタグのみ抽出
exiftool -ee3 -Protobuf:all CAM_20260205143223_0028_D.OSV

# ジャイロデータの検索
exiftool -ee3 -Protobuf:AngularVelocity* CAM_20260205143223_0028_D.OSV
```

**期待される結果**:
- より詳細なProtobufフィールドの抽出
- 隠れたセンサーデータの発見（ジャイロなど）
- タイムスタンプと値の正確な対応付け

---

## 📊 データ抽出の実績

### 成功したデータ

```bash
# IMUデータ (Accelerometer)
imu_timeseries.csv - 2,310レコード

# ストリーム抽出
stream3_djmd.bin - 2.1 MB (カメラメタデータ)
stream4_djmd.bin - 325 KB (カメラメタデータ)
stream5_dbgi.bin - 20 MB (デバッグ情報)
stream6_dbgi.bin - 20 MB (デバッグ情報)
```

### 推奨される次のステップ

1. **exiftoolのインストールと実行**
   - Protobufデータの完全な抽出
   - ジャイロデータの再確認

2. **Protobufスキーマの取得**
   - DJI公式サポートへの問い合わせ
   - SDKドキュメントの確認

3. **代替的な位置推定手法**
   - Visual Odometry（映像フレームからの位置推定）
   - Structure from Motion (SfM)
   - 環境マッピングとの組み合わせ

---

## 🔄 自己位置推定の実現可能性

### 現在利用可能な手法

#### 1. 加速度のみによる推定（精度：低）
```
手法: 二重積分
入力: AccelerometerX/Y/Z
出力: 相対位置（ドリフトあり）
精度: 数メートル〜数十メートル誤差/分
用途: 大まかな動きのパターン把握
```

**実装済み**: `plot_trajectory_3d_simple.py`

#### 2. Visual Odometry（精度：中〜高）
```
手法: フレーム間の特徴点追跡
入力: left_eye.mp4, right_eye.mp4
出力: カメラの相対位置・姿勢
精度: 数cm〜数十cm誤差/m
用途: 屋内ナビゲーション、3Dマッピング
```

**必要な実装**:
- ステレオマッチング
- 特徴点検出・追跡（SIFT, ORB, etc.）
- カメラキャリブレーション
- バンドル調整

#### 3. ハイブリッド手法（精度：高）
```
手法: IMU + Visual Odometry 融合
入力: 加速度 + 映像フレーム
出力: 高精度な位置・姿勢
精度: 数cm誤差/m
用途: プロフェッショナルな3D再構成
```

**必要な実装**:
- カルマンフィルタまたは拡張カルマンフィルタ
- センサー融合アルゴリズム
- スケール推定

---

## 📝 結論

### 発見されたデータ
✅ **加速度データ** - 利用可能
❌ **ジャイロデータ** - 未検出
❌ **GPSデータ** - 未検出
❌ **磁気・気圧センサー** - 未検出
✅ **カメラメタデータ** - Protobuf形式で存在（詳細は要解析）

### 自己位置推定の推奨アプローチ

1. **短期的**: 加速度のみの簡易推定（既に実装済み）
   - 動きのパターン把握
   - 相対的な移動距離の概算

2. **中期的**: Visual Odometryの実装
   - 左右の映像を活用したステレオVO
   - より高精度な位置推定
   - 3D空間の再構成

3. **長期的**: センサー融合
   - 加速度 + Visual Odometry
   - 可能であればジャイロデータの追加取得方法を調査

### 制限事項

- **ジャイロデータの欠如**が最大の制約
- GPSがないため絶対位置は取得不可
- 加速度のみでは長時間の精度維持が困難
- Visual Odometryの実装には高度な画像処理技術が必要

---

## 🛠️ 生成されたファイル

```
check_osv_metadata.py        - MP4構造解析スクリプト
analyze_camd_box.py          - camdボックス解析スクリプト
osv_metadata_report.txt      - メタデータ一覧
stream3_djmd.bin             - カメラメタデータ (2.1 MB)
stream4_djmd.bin             - カメラメタデータ (325 KB)
stream5_dbgi.bin             - デバッグ情報 (20 MB)
stream6_dbgi.bin             - デバッグ情報 (20 MB)
```

---

## 📚 参考情報

### ファイル形式
- **MP4/MOV**: ISO Base Media File Format
- **HEVC**: H.265 Video Codec
- **Protobuf**: Google Protocol Buffers v2/v3

### 関連ツール
- **exiftool**: メタデータ抽出の標準ツール
- **ffmpeg/ffprobe**: 動画解析ツール
- **protoc**: Protobufコンパイラ

### DJI Osmo 360 仕様
- **イメージセンサー**: OmniVision OV68A40
- **解像度**: 3840x3840 (左右各)
- **フレームレート**: 30fps
- **IMU**: 3軸加速度計（ジャイロは仕様により異なる可能性）
